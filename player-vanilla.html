<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radio Radicale UNOFFICIAL player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      line-height: 1.5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 40px;
      border: 1px solid #ddd;
    }
    
    h1 {
      font-size: 24px;
      text-align: center;
      margin-bottom: 5px;
      color: #333;
    }
    
    .subtitle {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-bottom: 30px;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    
    .url-section {
      margin-bottom: 30px;
    }
    
    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
    }
    
    .input-wrapper {
      flex: 1;
      position: relative;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      font-size: 14px;
      -webkit-user-select: text;
      user-select: text;
    }
    
    input[type="text"]:focus {
      outline: 2px solid #ff6600;
      border-color: #ff6600;
    }
    
    .clear-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 18px;
      padding: 5px;
    }
    
    .clear-btn:hover { color: #333; }
    .hidden { display: none !important; }
    
    button {
      padding: 12px 24px;
      background: #ff6600;
      color: white;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    
    button:hover { background: #e65c00; }
    button:active { background: #cc5200; }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
    }
    
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      .container { padding: 20px; }
      h1 { font-size: 20px; }
    }
    
    /* Track selector */
    .track-selector {
      margin-bottom: 30px;
    }
    
    .track-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .track-btn {
      width: 100%;
      text-align: left;
      padding: 15px;
      border: 2px solid #ddd;
      background: white;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .track-btn:hover {
      border-color: #ff6600;
      background: #fff5f0;
    }
    
    .track-btn.active {
      border-color: #ff6600;
      background: #fff5f0;
    }
    
    .track-number {
      width: 32px;
      height: 32px;
      background: #ff6600;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
      flex-shrink: 0;
    }
    
    .track-info {
      flex: 1;
      min-width: 0;
    }
    
    .track-title {
      font-weight: 600;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .track-subtitle {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    
    .track-playing {
      color: #ff6600;
      font-size: 12px;
    }
    
    /* Waveform */
    .waveform {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      height: 64px;
      margin-bottom: 30px;
    }
    
    .bar {
      width: 4px;
      background: #ff6600;
      opacity: 0.3;
      transition: opacity 0.3s;
    }
    
    .bar.active { opacity: 1; }
    
    @keyframes wave {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(0.6); }
    }
    
    .bar.active {
      animation: wave 1s ease-in-out infinite;
    }
    
    .bar:nth-child(1) { height: 20px; animation-delay: 0s; }
    .bar:nth-child(2) { height: 36px; animation-delay: 0.1s; }
    .bar:nth-child(3) { height: 56px; animation-delay: 0.2s; }
    .bar:nth-child(4) { height: 40px; animation-delay: 0.3s; }
    .bar:nth-child(5) { height: 48px; animation-delay: 0.4s; }
    .bar:nth-child(6) { height: 32px; animation-delay: 0.5s; }
    .bar:nth-child(7) { height: 44px; animation-delay: 0.6s; }
    
    /* Progress bar */
    .progress-section {
      margin-bottom: 30px;
    }
    
    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      font-variant-numeric: tabular-nums;
    }
    
    .progress-container {
      position: relative;
      height: 8px;
      background: #e0e0e0;
      cursor: pointer;
    }
    
    .progress-bar {
      position: absolute;
      height: 100%;
      background: #ff6600;
      width: 0%;
      transition: width 0.1s;
    }
    
    .progress-handle {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      background: white;
      border: 2px solid #ff6600;
      border-radius: 50%;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      left: 0%;
    }
    
    .progress-container:hover .progress-handle { opacity: 1; }
    .progress-handle.seeking { opacity: 1 !important; }
    
    /* Controls */
    .controls {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .play-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #ff6600;
      color: white;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .play-btn:hover { background: #e65c00; }
    .play-btn:active { background: #cc5200; }
    
    .status {
      flex: 1;
      text-align: center;
      font-size: 14px;
      color: #666;
    }
    
    /* Speed control */
    .speed-control {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      background: #f9f9f9;
      margin-bottom: 20px;
    }
    
    .speed-icon {
      font-size: 20px;
      width: 24px;
      text-align: center;
      user-select: none;
    }
    
    input[type="range"] {
      flex: 1;
      height: 6px;
      background: #ddd;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: #ff6600;
      border-radius: 50%;
      cursor: pointer;
    }
    
    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: #ff6600;
      border-radius: 50%;
      border: none;
      cursor: pointer;
    }
    
    .speed-display {
      font-size: 14px;
      font-weight: 600;
      color: #ff6600;
      width: 48px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    
    /* Messages */
    .message {
      padding: 12px;
      font-size: 14px;
      margin-top: 15px;
      text-align: center;
    }
    
    .loading {
      color: #ff6600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #ff6600;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .success {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .error {
      background: #ffebee;
      color: #c62828;
    }
    
    /* Interventi */
    .interventi-container {
      border: 1px solid #ddd;
    }
    
    .interventi-header {
      background: #ff6600;
      color: white;
      padding: 12px 15px;
      font-weight: 600;
      font-size: 14px;
    }
    
    .interventi-list {
      max-height: 600px;
      overflow-y: auto;
    }
    
    .intervento {
      padding: 15px;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
    }
    
    .intervento:hover {
      background: #fff5f0;
    }
    
    .intervento.active {
      background: #fff5f0;
      border-left: 4px solid #ff6600;
    }
    
    .paragrafo {
      padding: 12px 15px;
      background: #f5f5f5;
      border-bottom: 1px solid #d0d0d0;
      cursor: default;
    }
    
    .intervento-nome {
      font-weight: 600;
      color: #333;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .intervento-ruolo {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .intervento-durata {
      font-size: 12px;
      color: #666;
    }
    
    .intervento-time {
      font-size: 12px;
      color: #ff6600;
      margin-top: 4px;
    }
    
    .paragrafo-title {
      font-weight: bold;
      color: #555;
      font-size: 14px;
    }
  </style>
</head>
<body>
  
  <div class="container">
    
    <!-- Header -->
    <h1 id="mainTitle">Radio Radicale UNOFFICIAL player</h1>
    <div class="subtitle" id="mainSubtitle">Streaming Audio</div>

    <!-- URL Input -->
    <div class="url-section">
      <label>URL Pagina Radio Radicale</label>
      <div class="input-row">
        <div class="input-wrapper">
          <input 
            type="text" 
            id="pageUrlInput"
            placeholder="https://www.radioradicale.it/scheda/..."
          >
          <button class="clear-btn hidden" id="clearBtn">✕</button>
        </div>
        <button id="loadBtn">Carica</button>
      </div>
      <div class="hint">Incolla l'URL di una pagina Radio Radicale per estrarre lo stream</div>
    </div>

    <div class="grid">
      
      <!-- Player Column -->
      <div>
        
        <!-- Track Selector -->
        <div class="track-selector hidden" id="trackSelectorContainer">
          <label>Seleziona traccia audio</label>
          <div class="track-list" id="trackList"></div>
        </div>

        <!-- Waveform -->
        <div class="waveform">
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-section">
          <div class="time-display">
            <span id="currentTime">00:00:00</span>
            <span id="duration">--:--:--</span>
          </div>
          <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
            <div class="progress-handle" id="progressHandle"></div>
          </div>
        </div>

        <!-- Controls -->
        <div class="controls">
          <button class="play-btn" id="playBtn" disabled>▶</button>
          <div class="status" id="status">Inserisci un URL</div>
        </div>

        <!-- Speed Control -->
        <div class="speed-control">
          <span class="speed-icon">⚡</span>
          <input type="range" id="speedSlider" min="50" max="250" step="25" value="100">
          <span class="speed-display" id="speedDisplay">1.0x</span>
        </div>

        <!-- Messages -->
        <div class="message loading hidden" id="loading">
          <div class="spinner"></div>
          <span id="loadingText">Caricamento...</span>
        </div>
        <div class="message success hidden" id="success"></div>
        <div class="message error hidden" id="error"></div>
      </div>

      <!-- Interventi Column -->
      <div>
        <div class="interventi-container hidden" id="interventiContainer">
          <div class="interventi-header">INTERVENTI</div>
          <div class="interventi-list" id="interventiList"></div>
        </div>
      </div>

    </div>

    <audio id="video" preload="metadata"></audio>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const video = $('video');
    const playBtn = $('playBtn');
    const currentTimeDisplay = $('currentTime');
    const durationDisplay = $('duration');
    const statusDisplay = $('status');
    const speedSlider = $('speedSlider');
    const speedDisplay = $('speedDisplay');
    const loading = $('loading');
    const loadingText = $('loadingText');
    const errorBox = $('error');
    const successBox = $('success');
    const bars = document.querySelectorAll('.bar');
    const progressContainer = $('progressContainer');
    const progressBar = $('progressBar');
    const progressHandle = $('progressHandle');
    const pageUrlInput = $('pageUrlInput');
    const loadBtn = $('loadBtn');
    const clearBtn = $('clearBtn');
    const trackSelectorContainer = $('trackSelectorContainer');
    const trackList = $('trackList');
    const interventiContainer = $('interventiContainer');
    const interventiList = $('interventiList');
    const mainTitle = $('mainTitle');
    const mainSubtitle = $('mainSubtitle');
    
    let isPlaying = false;
    let isSeeking = false;
    let currentHls = null;
    let availableTracks = [];
    let currentTrackIndex = 0;
    let interventi = [];

    // Input helpers
    pageUrlInput.addEventListener('input', () => clearBtn.classList.toggle('hidden', !pageUrlInput.value));
    clearBtn.addEventListener('click', () => {
      pageUrlInput.value = '';
      clearBtn.classList.add('hidden');
      pageUrlInput.focus();
    });

    // Mobile text selection
    let lastTap = 0;
    pageUrlInput.addEventListener('click', () => {
      const now = Date.now();
      if (now - lastTap < 500) pageUrlInput.select();
      lastTap = now;
    });

    let longPress;
    pageUrlInput.addEventListener('touchstart', () => longPress = setTimeout(() => pageUrlInput.select(), 500));
    pageUrlInput.addEventListener('touchend', () => clearTimeout(longPress));
    pageUrlInput.addEventListener('touchmove', () => clearTimeout(longPress));

    // Format time
    const formatTime = seconds => {
      if (!isFinite(seconds)) return '--:--:--';
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      return h > 0 ? `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` : `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    };

    // Parse duration
    const parseDuration = str => {
      const h = (str.match(/(\d+)\s*ora/) || [0, 0])[1] * 3600;
      const m = (str.match(/(\d+)\s*min/) || [0, 0])[1] * 60;
      const s = (str.match(/(\d+)\s*sec/) || [0, 0])[1];
      return parseInt(h) + parseInt(m) + parseInt(s);
    };

    // Update main title
    const updateTitle = (title, index, total) => {
      mainTitle.textContent = title || 'Radio Radicale UNOFFICIAL player';
      mainSubtitle.textContent = total > 0 ? `Traccia ${index + 1} di ${total}` : 'Streaming Audio';
    };

    // Extract data
    async function extractData(pageUrl) {
      loadingText.textContent = 'Estrazione dati...';
      
      let html;
      try {
        const res = await fetch(pageUrl);
        html = await res.text();
      } catch {
        loadingText.textContent = 'Uso proxy CORS...';
        const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(pageUrl));
        html = await res.text();
      }
      
      const match = html.match(/Drupal\.settings\s*,\s*({[\s\S]*?})\);/);
      if (!match) throw new Error('Dati non trovati');
      
      const settings = JSON.parse(match[1]);
      if (!settings.RRscheda) throw new Error('RRscheda non trovato');
      
      const rrscheda = settings.RRscheda;
      
      // Tracks
      const tracks = [];
      if (rrscheda.playlist) {
        rrscheda.playlist.forEach((item, i) => {
          if (item.sources?.[0]?.src) {
            tracks.push({
              url: item.sources[0].src,
              title: item.title || `Traccia ${i + 1}`,
              index: i
            });
          }
        });
      }
      
      // Interventi
      const interventi = [];
      let order = 0;
      const liPattern = /<li class="(int\d+)[^"]*"[^>]*>([\s\S]*?)<\/li>/g;
      let liMatch;
      
      while ((liMatch = liPattern.exec(html))) {
        const id = liMatch[1];
        const content = liMatch[2];
        const isParagrafo = liMatch[0].includes('paragrafo');
        
        let offset = 0, file = 0;
        if (rrscheda.interventi?.[id]) {
          offset = rrscheda.interventi[id].offset || 0;
          file = rrscheda.interventi[id].file || 0;
        }
        
        if (isParagrafo) {
          const m = content.match(/<p class="strong descrizione">([^<]+)<\/p>/);
          if (m) {
            interventi.push({
              tipo: 'paragrafo',
              titolo: m[1].trim(),
              offset, file,
              htmlOrder: order++
            });
          }
        } else {
          const section = content.match(/<div class="int_name_section">([\s\S]*?)<\/div>/);
          if (section) {
            const html = section[1];
            const nomi = [...html.matchAll(/<h2>([^<]+)<\/h2>/g)].map(m => m[1].trim());
            const ruoli = [...html.matchAll(/<p>([^<]+)<\/p>/g)]
              .map(m => m[1].trim())
              .filter(t => !t.includes('Durata:') && !t.match(/^\d+:\d+/));
            
            const durataM = html.match(/Durata:\s*([^<]+)/);
            const durata = durataM ? durataM[1].trim() : '';
            const orarioM = html.match(/(\d+:\d+)\s+Durata:/);
            const orario = orarioM ? orarioM[1] : '';
            
            nomi.forEach((nome, i) => {
              interventi.push({
                tipo: 'intervento',
                nome,
                ruolo: ruoli[i] || '',
                durata,
                orario,
                offset, file,
                htmlOrder: order++
              });
            });
          }
        }
      }
      
      return { tracks, interventi };
    }

    // Display interventi
    function displayInterventi(data) {
      interventi = data;
      if (!data.length) {
        interventiContainer.classList.add('hidden');
        return;
      }
      
      interventiContainer.classList.remove('hidden');
      interventiList.innerHTML = '';
      
      data.forEach(int => {
        const div = document.createElement('div');
        
        if (int.tipo === 'paragrafo') {
          div.className = 'paragrafo';
          div.innerHTML = `<div class="paragrafo-title">${int.titolo}</div>`;
        } else {
          div.className = 'intervento';
          div.innerHTML = `
            <div class="intervento-nome">${int.nome}</div>
            ${int.ruolo ? `<div class="intervento-ruolo">${int.ruolo}</div>` : ''}
            ${int.durata ? `<div class="intervento-durata">${int.durata}</div>` : ''}
            <div class="intervento-time">
              ${int.orario ? `${int.orario} - ` : ''}
              ${int.file > 0 ? `File ${int.file + 1} - ` : ''}
              ${formatTime(int.offset)}
            </div>
          `;
          
          div.addEventListener('click', () => {
            if (int.file !== currentTrackIndex && availableTracks[int.file]) {
              currentTrackIndex = int.file;
              loadTrack(int.file, int.offset);
              if (availableTracks.length > 1) displayTrackSelector(availableTracks);
            } else {
              video.currentTime = int.offset;
              if (!isPlaying) video.play();
            }
            
            interventiList.querySelectorAll('.intervento').forEach(el => el.classList.remove('active'));
            div.classList.add('active');
          });
        }
        
        interventiList.appendChild(div);
      });
    }

    // Display track selector
    function displayTrackSelector(tracks) {
      availableTracks = tracks;
      if (tracks.length === 1) {
        trackSelectorContainer.classList.add('hidden');
        return;
      }
      
      trackSelectorContainer.classList.remove('hidden');
      trackList.innerHTML = '';
      
      tracks.forEach((track, i) => {
        const btn = document.createElement('button');
        btn.className = 'track-btn' + (i === currentTrackIndex ? ' active' : '');
        
        btn.innerHTML = `
          <div class="track-number">${i + 1}</div>
          <div class="track-info">
            <div class="track-title">${track.title}</div>
            <div class="track-subtitle">Parte ${i + 1} di ${tracks.length}</div>
          </div>
          ${i === currentTrackIndex ? '<span class="track-playing">▶</span>' : ''}
        `;
        
        btn.addEventListener('click', () => {
          currentTrackIndex = i;
          loadTrack(i);
          displayTrackSelector(tracks);
        });
        
        trackList.appendChild(btn);
      });
    }

    // Load track
    function loadTrack(index, startTime = 0) {
      if (index < 0 || index >= availableTracks.length) return;
      
      const track = availableTracks[index];
      currentTrackIndex = index;
      updateTitle(track.title, index, availableTracks.length);
      initPlayer(track.url, startTime);
    }

    // Init player
    function initPlayer(src, startTime = 0) {
      if (currentHls) {
        currentHls.destroy();
        currentHls = null;
      }
      
      if (video.src) {
        video.pause();
        video.src = '';
      }
      
      isPlaying = false;
      playBtn.innerHTML = '▶';
      progressBar.style.width = '0%';
      progressHandle.style.left = '0%';
      currentTimeDisplay.textContent = '00:00:00';
      durationDisplay.textContent = '--:--:--';
      loadingText.textContent = 'Inizializzazione...';
      loading.classList.remove('hidden');
      
      const onReady = () => {
        statusDisplay.textContent = 'Pronto';
        loading.classList.add('hidden');
        playBtn.disabled = false;
        if (startTime > 0) video.currentTime = startTime;
        successBox.textContent = '✓ Traccia caricata!';
        successBox.classList.remove('hidden');
        setTimeout(() => successBox.classList.add('hidden'), 3000);
      };
      
      if (Hls.isSupported()) {
        currentHls = new Hls();
        currentHls.loadSource(src);
        currentHls.attachMedia(video);
        currentHls.on(Hls.Events.MANIFEST_PARSED, onReady);
        currentHls.on(Hls.Events.ERROR, (e, data) => {
          if (data.fatal) {
            errorBox.textContent = 'Errore: ' + (data.details || 'unknown');
            errorBox.classList.remove('hidden');
            loading.classList.add('hidden');
            playBtn.disabled = true;
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = src;
        video.addEventListener('loadedmetadata', onReady, { once: true });
      } else {
        errorBox.textContent = 'Browser non supporta HLS';
        errorBox.classList.remove('hidden');
        loading.classList.add('hidden');
      }
    }

    // Load button
    loadBtn.addEventListener('click', async () => {
      const url = pageUrlInput.value.trim();
      if (!url) return errorBox.textContent = 'Inserisci un URL', errorBox.classList.remove('hidden');
      if (!url.includes('radioradicale.it')) return errorBox.textContent = 'URL non valido', errorBox.classList.remove('hidden');
      
      errorBox.classList.add('hidden');
      successBox.classList.add('hidden');
      trackSelectorContainer.classList.add('hidden');
      interventiContainer.classList.add('hidden');
      loading.classList.remove('hidden');
      loadBtn.disabled = true;
      playBtn.disabled = true;
      statusDisplay.textContent = 'Caricamento...';
      
      try {
        const data = await extractData(url);
        if (!data.tracks.length) throw new Error('Nessuna traccia');
        
        displayTrackSelector(data.tracks);
        displayInterventi(data.interventi);
        loadTrack(0);
        loading.classList.add('hidden');
      } catch (err) {
        errorBox.textContent = err.message || 'Errore';
        errorBox.classList.remove('hidden');
        loading.classList.add('hidden');
        statusDisplay.textContent = 'Errore';
      } finally {
        loadBtn.disabled = false;
      }
    });

    pageUrlInput.addEventListener('keypress', e => e.key === 'Enter' && loadBtn.click());

    // Play/Pause
    playBtn.addEventListener('click', () => isPlaying ? video.pause() : video.play());
    video.addEventListener('play', () => {
      isPlaying = true;
      playBtn.innerHTML = '⏸';
      statusDisplay.textContent = 'In riproduzione';
      bars.forEach(b => b.classList.add('active'));
    });
    video.addEventListener('pause', () => {
      isPlaying = false;
      playBtn.innerHTML = '▶';
      statusDisplay.textContent = 'In pausa';
      bars.forEach(b => b.classList.remove('active'));
    });
    video.addEventListener('ended', () => {
      if (currentTrackIndex < availableTracks.length - 1) {
        currentTrackIndex++;
        loadTrack(currentTrackIndex);
        displayTrackSelector(availableTracks);
        video.addEventListener('loadedmetadata', () => video.play(), { once: true });
      }
    });

    // Time update
    video.addEventListener('loadedmetadata', () => durationDisplay.textContent = formatTime(video.duration));
    video.addEventListener('durationchange', () => durationDisplay.textContent = formatTime(video.duration));
    video.addEventListener('timeupdate', () => {
      if (!isSeeking && video.duration) {
        const pct = (video.currentTime / video.duration) * 100;
        progressBar.style.width = pct + '%';
        progressHandle.style.left = pct + '%';
        currentTimeDisplay.textContent = formatTime(video.currentTime);
      }
    });

    // Seek
    const seek = e => {
      const rect = progressContainer.getBoundingClientRect();
      const x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
      const pct = Math.max(0, Math.min(1, (x - rect.left) / rect.width));
      const time = pct * video.duration;
      
      if (isFinite(time)) {
        progressBar.style.width = (pct * 100) + '%';
        progressHandle.style.left = (pct * 100) + '%';
        currentTimeDisplay.textContent = formatTime(time);
      }
      return pct;
    };

    const startSeeking = e => {
      e.preventDefault();
      isSeeking = true;
      progressHandle.classList.add('seeking');
      seek(e);
      document.addEventListener('mousemove', seek);
      document.addEventListener('touchmove', seek);
      document.addEventListener('mouseup', stopSeeking);
      document.addEventListener('touchend', stopSeeking);
    };

    const stopSeeking = e => {
      if (!isSeeking) return;
      const pct = seek(e);
      if (isFinite(pct * video.duration)) video.currentTime = pct * video.duration;
      
      isSeeking = false;
      progressHandle.classList.remove('seeking');
      document.removeEventListener('mousemove', seek);
      document.removeEventListener('touchmove', seek);
      document.removeEventListener('mouseup', stopSeeking);
      document.removeEventListener('touchend', stopSeeking);
    };

    progressContainer.addEventListener('mousedown', startSeeking);
    progressContainer.addEventListener('touchstart', startSeeking);

    // Speed
    speedSlider.addEventListener('input', e => {
      const speed = e.target.value / 100;
      video.playbackRate = speed;
      speedDisplay.textContent = speed.toFixed(1) + 'x';
    });
    video.playbackRate = 1.0;
  </script>
</body>
</html>